<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Defensives / Avoidable Damage</title>
    <style>
      :root {
        --bg:#0b0e14; --panel:#11151d; --panel2:#0f1420; --border:#1f2937;
        --text:#e5e7eb; --muted:#9aa4b2; --link:#93c5fd; --linkhover:#bfdbfe;
        --bossh:#141a29;
      }
      body.light {
        --bg:#fff; --panel:#f9fafb; --panel2:#fff; --border:#e5e7eb; --text:#111827; --muted:#6b7280;
        --link:#1d4ed8; --linkhover:#1e40af; --bossh:#eef2ff;
      }
      html,body{margin:0;padding:0}
      body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;padding:24px}
      .wrap{max-width:1100px;margin:0 auto}
      h1{margin:0 0 8px}
      .nav-links{display:flex;gap:12px;margin-bottom:20px}
      .nav-links a{background:var(--panel);border:1px solid var(--border);padding:8px 16px;border-radius:8px;text-decoration:none;color:var(--text);font-weight:600}
      .nav-links a:hover{background:var(--panel2);color:var(--link)}
      .nav-links a.active{background:var(--link);color:var(--bg)}
      .sub{color:var(--muted);margin:6px 0 12px}
      details{margin-bottom:12px;border:1px solid var(--border);border-radius:10px;padding:8px 12px;background:var(--panel)}
      summary{font-weight:600;cursor:pointer}
      table{width:100%;border-collapse:collapse;margin-top:8px}
      th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left}
      th{background:var(--panel2);position:sticky;top:0}
      .bossh{background:var(--bossh);font-weight:600}
      .muted{color:var(--muted)}
      .link-group{display:flex;gap:8px;flex-wrap:wrap;margin:4px 0}
      .wcl-link{background:var(--panel2);border:1px solid var(--border);padding:6px 12px;border-radius:6px;text-decoration:none;color:var(--link);font-size:13px;display:inline-block}
      .wcl-link:hover{background:var(--border)}
      a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    </style>
    <script>
      const state = { data:null };

      async function bootstrap(){
        const res = await fetch('data.json', {cache:'no-store'});
        state.data = await res.json();

        document.getElementById('meta').innerHTML =
          `Authors: ${(state.data.meta.authorFilters||[]).join('; ') || 'All'} · Date ≤ ${state.data.meta.dateCutoff} · Generated ${state.data.meta.generatedAt}`;

        buildPlayerList();
      }

      function buildPlayerList(){
        const wrap = document.getElementById('content');
        wrap.innerHTML = '';
        const eventsAll = state.data.events;
        const pullsMap = state.data.pullParticipation;
        const bossPart = state.data.bossParticipation;

        const players = Object.keys(eventsAll).sort();
        
        players.forEach(player => {
          const totalPulls = (pullsMap[player] || []).length;
          
          const details = document.createElement('details');
          const summary = document.createElement('summary');
          summary.innerHTML = `${player} — <span class='muted'>${totalPulls} pulls</span>`;
          details.appendChild(summary);
          
          details.addEventListener('toggle', () => {
            if (!details.open || details.dataset.built) return;
            details.dataset.built = '1';
            
            const table = document.createElement('table');
            table.innerHTML = "<thead><tr><th>Boss</th><th>Pull #</th><th>Analysis Links</th></tr></thead><tbody></tbody>";
            const tbody = table.querySelector('tbody');

            const playerEvents = eventsAll[player];
            const byBoss = {};
            for (const ev of playerEvents){ (byBoss[ev.boss] ||= []).push(ev); }

            for (const boss of Object.keys(byBoss).sort((a,b)=> a.localeCompare(b))){
              const bossRows = byBoss[boss];
              const bossPulls = new Set((bossPart[boss] && bossPart[boss][player]) || []).size;
              
              const trH = document.createElement('tr');
              trH.className = 'bossh';
              trH.innerHTML = `<td colspan="3">${boss} — ${bossPulls} pulls</td>`;
              tbody.appendChild(trH);

              const pullsProcessed = new Set();
              for (const ev of bossRows.sort((a,b)=> a.pullNo - b.pullNo)){
                const pullKey = `${ev.reportId}_${ev.fightId}`;
                if (pullsProcessed.has(pullKey)) continue;
                pullsProcessed.add(pullKey);

                const tr = document.createElement('tr');
                const links = `
                  <div class="link-group">
                    <a href="https://www.warcraftlogs.com/reports/${ev.reportId}#fight=${ev.fightId}&type=damage-taken&source=${encodeURIComponent(player)}" target="_blank" class="wcl-link">Damage Taken</a>
                    <a href="https://www.warcraftlogs.com/reports/${ev.reportId}#fight=${ev.fightId}&type=auras&source=${encodeURIComponent(player)}" target="_blank" class="wcl-link">Consumables</a>
                    <a href="https://www.warcraftlogs.com/reports/${ev.reportId}#fight=${ev.fightId}&type=casts&source=${encodeURIComponent(player)}" target="_blank" class="wcl-link">Defensive CDs</a>
                  </div>
                `;
                tr.innerHTML = `<td>${boss}</td><td>${ev.pullNo}</td><td>${links}</td>`;
                tbody.appendChild(tr);
              }
            }
            
            details.appendChild(table);
          }, {once:true});

          wrap.appendChild(details);
        });
      }

      window.addEventListener('DOMContentLoaded', bootstrap);
    </script>
    </head>
<body>
  <div class="wrap">
    <div class="nav-links">
      <a href="index.html">Death Report</a>
      <a href="performance.html" class="active">Defensives / Avoidable Damage</a>
    </div>
    <h1>Defensives / Avoidable Damage</h1>
    <div id="meta" class="sub"></div>
    <div class="sub">Click any player to see WarcraftLogs analysis links for their pulls</div>
    <div id="content"></div>
  </div>
</body></html>
