<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Do Over – Death Report</title>
<style>
:root { --bg:#0b0f14; --fg:#e9eef3; --muted:#90a4ae; --chip:#1f2a33; --accent:#7aa2f7; --warn:#ffb454; }
body { background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin:0; }
header { display:flex; gap:12px; align-items:center; padding:16px 20px; position:sticky; top:0; background: rgba(11,15,20,.9); backdrop-filter: blur(6px); border-bottom:1px solid #223; z-index:10; }
h1 { font-size:18px; margin:0; font-weight:600; }
select, button { background:#101820; color:var(--fg); border:1px solid #24313c; border-radius:10px; padding:8px 10px; }
.container { padding: 10px 18px 60px; }
.card { background:#0f1720; border:1px solid #1b2630; border-radius:14px; padding:14px; margin:12px 0; }
.row { display:flex; gap:10px; align-items:center; justify-content: space-between; }
.badge { padding:2px 8px; border-radius:999px; background:#16202a; border:1px solid #24313c; color:var(--muted); font-size:12px; }
.badge.out { color: #111; background: var(--warn); border-color:#d5942c; }
.chips { display:flex; gap:8px; flex-wrap: wrap; }
.chip { padding:6px 9px; border-radius:999px; background:var(--chip); border:1px solid #22313d; cursor:pointer; user-select:none; }
.chip.sel { outline: 2px solid var(--accent); }
.small { font-size:12px; color: var(--muted); }
table { width:100%; border-collapse: collapse; margin-top: 8px; }
th, td { text-align:left; padding:6px 8px; border-bottom:1px solid #1b2630; }
thead th { position: sticky; top: 64px; background:#0f1720; }
</style>
</head>
<body>
<header>
  <h1>Do Over – Death Report</h1>
  <label class="small">Show deaths ≤ 
    <select id="cutoff"></select>
  </label>
  <div id="chips" class="chips"></div>
  <span id="meta" class="small"></span>
</header>
<div class="container">
  <div id="overall" class="card"></div>
  <div id="players"></div>
</div>
<script>
(async function() {
  const resp = await fetch('data.json');
  const data = await resp.json();
  const cutoffSel = document.getElementById('cutoff');
  for (let i=1;i<=data.meta.max_cutoff;i++) {
    const opt = document.createElement('option');
    opt.value = i; opt.textContent = i + ' Deaths';
    cutoffSel.appendChild(opt);
  }
  cutoffSel.value = localStorage.getItem('cutoff') || 3;
  cutoffSel.addEventListener('change', () => {
    localStorage.setItem('cutoff', cutoffSel.value);
    render();
  });

  const chipsDiv = document.getElementById('chips');
  const selected = new Set(JSON.parse(localStorage.getItem('bossFilter')||'[]'));
  function toggleChip(id) {
    if (selected.has(id)) selected.delete(id); else selected.add(id);
    localStorage.setItem('bossFilter', JSON.stringify([...selected]));
    render();
  }
  function chip(b) {
    const el = document.createElement('span');
    el.className = 'chip' + (selected.has(b.id)?' sel':'');
    el.textContent = b.name + ' (' + b.pulls + ')';
    el.onclick = () => toggleChip(b.id);
    return el;
  }
  data.bosses.forEach(b => chipsDiv.appendChild(chip(b)));
  document.getElementById('meta').textContent = `Pulls: ${data.bosses.reduce((a,b)=>a+b.pulls,0)} | Generated ${new Date(data.meta.generated_at).toLocaleString()}`;

  function passesBossFilter(bid) {
    if (selected.size === 0) return true;
    return selected.has(bid);
  }

  function rateBadge(player, bid) {
    const pulls = (data.bosses.find(b=>b.id==bid)||{pulls:1}).pulls;
    const deaths = (data.players[player].byBoss[bid]||0);
    const rate = deaths / Math.max(1,pulls);
    const med = data.bossMedians[bid] || 0;
    const isOut = (rate > 1.5 * med) && pulls >= 2;
    const span = document.createElement('span');
    span.className = 'badge' + (isOut ? ' out' : '');
    span.textContent = isOut ? 'outlier' : (deaths + '/' + pulls);
    span.title = `Deaths ${deaths} over ${pulls} pulls; median=${med.toFixed(2)}`;
    return span;
  }

  function render() {
    const cutoff = +cutoffSel.value;
    const overallDiv = document.getElementById('overall');
    const playersDiv = document.getElementById('players');
    overallDiv.innerHTML = ''; playersDiv.innerHTML = '';

    // overall
    const tbl = document.createElement('table');
    tbl.innerHTML = '<thead><tr><th>Player</th><th>Total</th></tr></thead>';
    const tb = document.createElement('tbody');
    data.overall.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.player}</td><td>${r.total}</td>`;
      tb.appendChild(tr);
    });
    tbl.appendChild(tb); overallDiv.appendChild(tbl);

    // players
    for (const player of Object.keys(data.players)) {
      const card = document.createElement('div'); card.className='card';
      const row = document.createElement('div'); row.className='row';
      const h = document.createElement('div'); h.textContent = player;
      row.appendChild(h);
      card.appendChild(row);

      // per-boss rows
      const tbl2 = document.createElement('table');
      tbl2.innerHTML = '<thead><tr><th>Boss</th><th>Rate</th><th>Recent deaths</th></tr></thead>';
      const tb2 = document.createElement('tbody');
      for (const b of data.bosses) {
        if (!passesBossFilter(b.id)) continue;
        const deaths = (data.players[player].details[String(b.id)]||[]).slice(-cutoff);
        const tr = document.createElement('tr');
        const badge = rateBadge(player, String(b.id));
        const nameTd = document.createElement('td');
        nameTd.textContent = b.name;
        const rateTd = document.createElement('td'); rateTd.appendChild(badge);
        const detTd = document.createElement('td');
        detTd.textContent = deaths.map(d => `${(d.t/1000).toFixed(0)}s: ${d.ability}`).join(' • ') || '—';
        tb2.appendChild(tr);
        tr.appendChild(nameTd); tr.appendChild(rateTd); tr.appendChild(detTd);
      }
      tbl2.appendChild(tb2); card.appendChild(tbl2);
      playersDiv.appendChild(card);
    }
  }
  render();
})();
</script>
</body>
</html>
